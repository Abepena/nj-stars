# Changelog: December 17, 2025

> **Review Status:** Pending
> **Session Focus:** CMS Audit Review, Admin Panel Migration, Bug Fixes, Map Enhancements

---

## Bug Fixes

### Event Registration Modal - Auth Token Fix
**Files:** `frontend/src/components/event-registration-modal.tsx`

**Issue:** Registration form showed "Authentication credentials were not provided" error because:
- Frontend was looking for `session.accessToken` (doesn't exist)
- Frontend was using `Bearer` prefix instead of `Token`

**Fix:**
- Changed `accessToken` ‚Üí `apiToken` (what `auth.ts` actually stores)
- Changed `Bearer ${token}` ‚Üí `Token ${token}` (Django TokenAuthentication format)

---

### Product QuickView - Image Index Preservation
**Files:** `frontend/src/components/product-quick-view.tsx`

**Issue:** Switching colors reset the image gallery to index 0, even if the new color had enough images to show the current index.

**Fix:**
- Extracted `getImagesForColor()` helper function
- Modified useEffect to only reset index if `currentImageIndex >= newColorImages.length`
- Preserves user's position when switching between colors with equal image counts


---

### Events Page - Infinite Loop Fix
**Files:** `frontend/src/app/events/page.tsx`

**Issue:** "Maximum update depth exceeded" error when loading the events page with calendar view.

**Root Cause:** 
- `selectedDayEvents` was computed fresh on every render (new array reference)
- This was in the useEffect dependency array, causing React to re-run the effect each render
- Effect called `setMapFocusedEvents()` which triggered parent re-render -> infinite loop

**Fix:**
1. Memoized `selectedDayEvents` with `useMemo(() => ..., [selectedDate, events])`
2. Created stable `handleDateSelect` callback with `useCallback`
3. Replaced inline `onDateSelect` function with the memoized callback


---

## Backend API Enhancements

### Events API - Full CRUD Support
**Files:** `backend/apps/events/views.py`, `backend/apps/events/serializers.py`

**Before:** `ReadOnlyModelViewSet` (GET only)
**After:** `ModelViewSet` with full CRUD + custom actions

**New Endpoints:**
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/events/` | Create new event |
| PUT/PATCH | `/api/events/{slug}/` | Update event |
| DELETE | `/api/events/{slug}/` | Delete event |
| POST | `/api/events/{slug}/duplicate/` | Clone event |
| POST | `/api/events/{slug}/toggle_registration/` | Open/close registration |
| POST | `/api/events/{slug}/toggle_public/` | Publish/unpublish |

**Permissions:**
- List/Retrieve: `AllowAny` (public events only for anonymous users)
- Create/Update/Delete: `IsStaffMember` required
- Staff sees ALL events including drafts

---

### New Permission Class
**Files:** `backend/apps/portal/permissions.py`

Added `IsAdminUser` permission class:
- Checks `user.is_superuser`, `user.is_staff`, or `user.profile.role == 'admin'`
- For admin-only operations (full CRUD on sensitive data)

---

## Frontend Admin Pages

### Events Management Page (NEW)
**Files:** `frontend/src/app/portal/dashboard/admin/events/page.tsx`

**Features:**
- Full event list with search, type filter, status filter
- Table view with: title, location, price, date, type badge, status badges
- Quick actions dropdown:
  - View on Site
  - Edit (links to edit page)
  - Toggle Registration (open/close)
  - Toggle Public (publish/draft)
  - Duplicate
  - Delete (with confirmation)
- Loading skeleton
- Past events shown with reduced opacity

---

### Admin Dashboard - New Quick Action
**Files:** `frontend/src/app/portal/dashboard/admin/page.tsx`

Added "Manage Events" and "Create Event" quick action cards

---

### Printify Admin Consolidation
**Files:**
- `frontend/src/components/admin/printify-section.tsx` (NEW)
- `frontend/src/components/ui/collapsible.tsx` (NEW)
- `frontend/src/app/portal/dashboard/admin/page.tsx`
- `frontend/src/app/portal/dashboard/admin/printify/page.tsx`
- `frontend/src/app/portal/dashboard/layout.tsx`

**Goal:** Consolidate Printify management into the Admin Dashboard instead of a separate page.

**Changes:**
1. **Created `PrintifyAdminSection` component** - Collapsible card that:
   - Shows "Printify Store" header with product count badge
   - Lazy-loads products when first expanded (reduces initial load)
   - "Sync from Printify" button to import products
   - "Open Printify Dashboard" external link
   - Product list with images, titles, prices, publish status
   - Loading skeleton and error states

2. **Created `collapsible.tsx` UI component** - Wrapper for `@radix-ui/react-collapsible`
   - Installed `@radix-ui/react-collapsible` package
   - Exports `Collapsible`, `CollapsibleTrigger`, `CollapsibleContent`

3. **Updated Admin Dashboard** - Added `<PrintifyAdminSection />` after Quick Actions

4. **Replaced standalone Printify page** - Now redirects to `/portal/dashboard/admin`

5. **Removed Printify from sidebar** - No longer a separate navigation item

**UX Improvement:** Admins now have all management tools in one dashboard view instead of navigating to separate pages.

---

### Event Edit Page (NEW)
**Files:** `frontend/src/app/portal/dashboard/admin/events/[slug]/edit/page.tsx`

**Features:**
- Fetch event by slug and pre-populate form
- Full form with all event fields organized into cards:
  - Basic Information (title, type, description)
  - Date & Time (start, end, registration deadline)
  - Location (address, lat/lng coordinates)
  - Capacity & Payment (max participants, price toggle)
  - Visibility & Status (public/draft, registration open/closed)
- PUT request to update event
- Validation error display with field-level messages
- Success message and redirect after save
- Loading skeleton during fetch
- Handles `?created=true` query param for post-creation flow

---

### Event Create Page (NEW)
**Files:** `frontend/src/app/portal/dashboard/admin/events/new/page.tsx`

**Features:**
- Same form structure as edit page
- Smart defaults: start time = next hour, end time = 3 hours later
- POST request to create event
- Redirects to edit page after creation with success message
- Form validation and error display

---

### Roster Management Page (NEW)
**Files:** `frontend/src/app/portal/dashboard/admin/roster/page.tsx`

**Features:**
- Complete player roster with search, position filter, waiver filter
- Table view with: player name, jersey #, age/grade, position badge, guardian info, waiver status
- Position color-coded badges (PG, SG, SF, PF, C)
- Export roster to CSV with all player and guardian details
- Quick actions: View Details, Edit Player, Email Guardian
- Age calculation from DOB
- Loading skeleton

---

### Check-Ins Management Page (NEW)
**Files:** `frontend/src/app/portal/dashboard/admin/check-ins/page.tsx`

**Features:**
- Event-based check-in system grouped by event
- Stats cards: Total Registered, Checked In, Pending
- Date filter: Today, Upcoming, Past Events, All
- Search by participant name or email
- One-click check-in button for each registrant
- Real-time UI updates when checking in
- Shows check-in time for completed check-ins
- Events grouped into cards with registration count
- Disabled check-in for future events

---

### Registrations Management Page (NEW)
**Files:** `frontend/src/app/portal/dashboard/admin/registrations/page.tsx`

**Features:**
- All event registrations in unified view
- Stats cards: Total, Paid, Pending, Revenue
- Filters: Search, Event filter, Payment status filter
- Payment status badges with icons (Paid, Pending, Failed, Refunded, Free)
- Shows registration date, check-in status, waiver status
- Export registrations to CSV with full participant details
- Quick actions: View Details, Email Participant, Go to Check-In, Process Refund
- Loading skeleton

---

## Documentation Updates

### TODOS.md - Major Update
**Files:** `documentation/TODOS.md`

**Checked off completed items:**
- [x] Google Maps integration (EventMap component)
- [x] List view as horizontal bars (EventCardHorizontal)
- [x] Newsletter signup form
- [x] CMS audit
- [x] Portal routes wired
- [x] Printify admin page

**Added new TODOs:**
- Player/Parent distinction on signup
- Hidden admin/coach signup route (`/portal/register/staff?invite=<token>`)
- Admin Panel Migration phases (API Foundation, Core UI, Feature Parity)

---

### CMS_AUDIT_REPORT.md - Status Update
**Files:** `documentation/CMS_AUDIT_REPORT.md`

Updated overall readiness from 40% ‚Üí 70%:
- Phase A (Admin Consolidation): ‚úÖ Complete
- Phase B (Dashboard): ‚úÖ Mostly Complete
- Phase C (Entity Polish): üîÑ In Progress
- Phase D (Reporting): ‚úÖ Complete
- Phase E (Communication): ‚ùå Not Started
- Phase F (Help Docs): ‚ùå Not Started

---

## Calendar UI Fix

### Date Number Alignment
**Files:** `frontend/src/app/events/page.tsx`

**Issue:** Date numbers were centered instead of top-left aligned in calendar cells

**Fix:** Removed `mx-auto md:mx-0` from the date number div class

---


---

## Map Enhancements

### Map Zoom to Selected Calendar Day
**Files:** `frontend/src/app/events/page.tsx`, `frontend/src/components/event-map.tsx`

**Feature:** When a user clicks a day on the calendar, the map now zooms to show events for that day.

**Implementation:**
- Added `focusedEvents={mapFocusedEvents}` prop to both mobile and desktop EventMap components
- `onDateSelect` callback from CalendarView passes selected day's events to state
- EventMap uses `useEffect` to pan/zoom when `focusedEvents` changes
- Single event: zooms to location and opens InfoWindow
- Multiple events: fits bounds to show all event markers
- No selection: resets to show all events on map

---

### Multiple Events at Same Location
**Files:** `frontend/src/components/event-map.tsx`

**Feature:** Handle multiple events that share the same venue/coordinates with a navigation selector.

**Implementation:**
- Added `LocationGroup` interface to group events by coordinates
- `getLocationKey()` rounds lat/lng to 4 decimal places (~10m tolerance)
- Markers show event count badge when multiple events share location
- InfoWindow includes prev/next navigation arrows with "X of Y events" indicator
- Cycling through events updates the selected event and notifies parent

**New UI Elements:**
- Count badge on markers (e.g., "3" for 3 events at location)
- Navigation header in InfoWindow: `< 1 of 3 events >`
- White stroke on multi-event markers for visual distinction

## Files Changed Summary

```
frontend/src/components/event-registration-modal.tsx              # Auth token fix
frontend/src/components/product-quick-view.tsx                    # Image index preservation
frontend/src/app/events/page.tsx                                  # Calendar date alignment + map zoom integration
frontend/src/components/event-map.tsx                             # Multi-event location grouping + navigation
frontend/src/app/portal/dashboard/admin/events/page.tsx           # NEW - Events management list
frontend/src/app/portal/dashboard/admin/events/[slug]/edit/page.tsx # NEW - Event edit form
frontend/src/app/portal/dashboard/admin/events/new/page.tsx       # NEW - Event create form
frontend/src/app/portal/dashboard/admin/roster/page.tsx           # NEW - Roster management
frontend/src/app/portal/dashboard/admin/check-ins/page.tsx        # NEW - Check-ins management
frontend/src/app/portal/dashboard/admin/registrations/page.tsx    # NEW - Registrations management
frontend/src/app/portal/dashboard/admin/page.tsx                  # Added Manage Events + Create Event + Printify section
frontend/src/app/portal/dashboard/admin/printify/page.tsx         # Replaced with redirect to admin dashboard
frontend/src/app/portal/dashboard/layout.tsx                      # Removed Printify from sidebar nav
frontend/src/components/admin/printify-section.tsx                # NEW - Collapsible Printify management
frontend/src/components/ui/collapsible.tsx                        # NEW - Radix UI collapsible wrapper
backend/apps/events/views.py                                      # Full CRUD + actions
backend/apps/events/serializers.py                                # Made slug read-only
backend/apps/portal/permissions.py                                # Added IsAdminUser
documentation/TODOS.md                                            # Updated checklist
documentation/CMS_AUDIT_REPORT.md                                 # Updated status
documentation/changelogs/2025-12-17.md                            # This file
```

---

## Testing Checklist

### Must Test Before Merge
- [ ] Event registration form works (guest + logged in)
- [ ] Product QuickView preserves image index when switching colors
- [ ] `/portal/dashboard/admin/events` loads and displays events
- [ ] `/portal/dashboard/admin/events/new` - Create event form submits successfully
- [ ] `/portal/dashboard/admin/events/[slug]/edit` - Edit page loads and saves changes
- [ ] Toggle registration works from events list
- [ ] Toggle public works from events list
- [ ] Duplicate event creates a copy
- [ ] Delete event removes it (with confirmation)
- [ ] `/portal/dashboard/admin/roster` - Roster loads with players
- [ ] Roster CSV export works
- [ ] `/portal/dashboard/admin/check-ins` - Check-ins page loads today's events
- [ ] Check-in button marks participant as checked in
- [ ] `/portal/dashboard/admin/registrations` - Registrations load with filters
- [ ] Registrations CSV export works
- [ ] Calendar date numbers are top-left aligned
- [ ] Map zooms to events when calendar day is clicked
- [ ] Map shows count badge on markers with multiple events
- [ ] InfoWindow prev/next navigation cycles through co-located events
- [ ] Map resets to show all events when no day is selected
- [ ] Printify section expands/collapses on admin dashboard
- [ ] Printify products load when section is first opened
- [ ] "Sync from Printify" button triggers sync
- [ ] "Open Printify Dashboard" opens external link
- [ ] `/portal/dashboard/admin/printify` redirects to admin dashboard

### Edge Cases
- [ ] Registration as guest (no auth token)
- [ ] Registration as logged-in user (with auth token)
- [ ] Switching colors when new color has fewer images (should reset to 0)
- [ ] Switching colors when new color has equal/more images (should preserve index)
- [ ] Staff user sees draft events in admin
- [ ] Non-staff user only sees public events

---

## Notes for Tomorrow

1. ~~**Map Zoom Feature** - ‚úÖ Completed (zoom to selected day's events)~~
2. ~~**Multiple Events at Location** - ‚úÖ Completed (prev/next navigation in InfoWindow)~~
3. ~~**Roster Admin Page** - ‚úÖ Completed~~
4. ~~**Check-Ins Admin Page** - ‚úÖ Completed~~
5. ~~**Registrations Admin Page** - ‚úÖ Completed~~
6. **Backend API Endpoints** - Need to create `/api/portal/admin/roster/`, `/api/portal/admin/check-ins/`, `/api/portal/admin/registrations/` endpoints
7. **React Query Setup** - Consider adding for better data fetching in admin pages
8. **Event Form Enhancements** - Consider adding address autocomplete using Google Maps integration
9. **Test Admin Pages** - Verify all admin pages work with real API data
